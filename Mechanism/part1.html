<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Making your first game, part 1</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var width=800;
var height=750;

var tileSize=50;

var game = new Phaser.Game(width, height, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render });

var map;

var layer1;
var layer2;

var number1;
var number2;
var number3;
var number4;
var number5;
var number6;
var number7;
var number8;
var number10;
var number11;
var number12;

var marker;

var tileType;

var line1;
var line2;
var line3;
var line4;
var line5;

var currentTile = 3;

var button1;
var button2;

var erasePipeBool;
var eraseDigBool;
var waterPathBool;

//Inicio mapa
var waterPos=[0,0];
var endCoords=[14,4];
var endCoords1=[10,4];
var startRock=[14,4];

var end1=false;
var end2=true;

var rockFirstStep=true;

var lastRockTile;

var mapCopy=new Array(16);
    

function preload() {

	game.load.image('fondo', 'assets/fondo1.png');
    //game.load.image('rock', 'assets/rockchico.png');
    game.load.image('grass', 'assets/grasschico.png');
    game.load.spritesheet('button1', 'assets/button1.png', 100,50);
    game.load.spritesheet('button2', 'assets/button2.png', 100,50);
    game.load.spritesheet('button3', 'assets/button3.png', 100,50);

    game.load.tilemap('map', 'assets/tilemap8.csv', null, Phaser.Tilemap.CSV);
    game.load.image('tiles', 'assets/tiles9.png');
    game.load.image('tileselector', 'assets/tileselector1.png');


    game.load.bitmapFont('desyrel', 'assets/fonts/desyrel.png', 'assets/fonts/desyrel.xml');
}

function create() {

    for(i=0; i<16; i++)
    {
        mapCopy[i]=new Array(12);
    }

    var widthTiles=width/tileSize;
    var heigthTiles=height/tileSize;

    //  A simple background for our game
    game.add.sprite(0, 0, 'fondo');

    //  Because we're loading CSV map data we have to specify the tile size here or we can't render it
    map = game.add.tilemap('map', tileSize, tileSize);

    //  Now add in the tileset
    map.addTilesetImage('tiles');
    
    //  Create our layer
    layer1 = map.createLayer(0);
    //  layer1 = map.create('background', 16, 15, 50, 50);
    //  Resize the world
    layer1.resizeWorld();

    //layer2=map.createLayer(1);
    //layer2=resizeWorld();
    /*
    waterPos=[0,1];

    colorMatrix=createArray(widthTiles, heightTiles);

    //iniciar matriz sin pintar
    for(var i=0; i<widthTiles; i++)
    {
        for(var j=0; j<heightTiles; j++)
        {
            colorMatrix[i][j]=false;
        }
    }
    */

    createTileSelector();

    var number1 = game.add.bitmapText(80, 60, 'desyrel', '1', 64);

    var number2 = game.add.bitmapText(280, 60, 'desyrel', '2', 64);

    var number3 = game.add.bitmapText(480, 60, 'desyrel', '3', 64);

    var number4 = game.add.bitmapText(680, 60, 'desyrel', '4', 64);

    var number5 = game.add.bitmapText(80, 260, 'desyrel', '5', 64);

    var number6 = game.add.bitmapText(280, 260, 'desyrel', '6', 64);

    var number7 = game.add.bitmapText(480, 260, 'desyrel', '7', 64);

    var number8 = game.add.bitmapText(680, 260, 'desyrel', '8', 64);

    var number9 = game.add.bitmapText(80, 460, 'desyrel', '9', 64);

    var number10 = game.add.bitmapText(280, 460, 'desyrel', '10', 64);

    var number11 = game.add.bitmapText(480, 460, 'desyrel', '11', 64);

    var number12 = game.add.bitmapText(680, 460, 'desyrel', '12', 64);

    line1 = new Phaser.Line(200, 0, 200, 600);
    line2 = new Phaser.Line(0, 200, 800, 200);
    line3 = new Phaser.Line(400, 0, 400, 600);
    line4 = new Phaser.Line(0, 400, 800, 400);
    line5 = new Phaser.Line(600, 0, 600, 600);

    game.input.addMoveCallback(updateMarker, this);

    //Botón erase pipe
    button1 = game.add.button(700, 600, 'button1', erasePipe, this, 0, 0, 1, 0);
    button1.input.useHandCursor = true;
    erasePipeBool=false;

    //Botón erase dig
    button2 = game.add.button(700, 700, 'button2', eraseDig, this, 0, 0, 1, 0);
    button2.input.useHandCursor = true;
    eraseDigBool=false;

    //Botón release water
    button3 = game.add.button(0, 600, 'button3', waterPath, this, 0, 0, 1, 0);
    button3.input.useHandCursor = true;
    waterPathBool=false;

    for(i=0; i<16; i++)
    {
        for(j=0; j<12; j++)
        {
        
            var markerX = layer1.getTileX(i*50) ;
            var markerY = layer1.getTileY(j*50) ;

            var auxTile;

            auxTile=map.getTile(markerX,markerY);

            //console.log('\n X:'+markerX+' Y: '+markerY+' Tile: '+auxTile.index);

            tileType=auxTile.index;

            mapCopy[i][j]=tileType;
        }
    }
}

function updateMarker() {

    marker.x = layer1.getTileX(game.input.activePointer.worldX) * 50;
    marker.y = layer1.getTileY(game.input.activePointer.worldY) * 50;


    var auxTile;

    //console.log('\n X:'+marker.x+' Y: '+marker.y);
    auxTile=map.getTile(layer1.getTileX(marker.x),layer1.getTileY(marker.y));

    tileType=auxTile.index;

    //solo cavar
    if (game.input.mousePointer.isDown && (tileType==0 || tileType==12) && currentTile==3)
    {
        map.putTile(currentTile, layer1.getTileX(marker.x), layer1.getTileY(marker.y), layer1);
        // map.fill(currentTile, currentLayer.getTileX(marker.x), currentLayer.getTileY(marker.y), 4, 4, currentLayer);
    }
    //poner tuberías
    else if(game.input.mousePointer.isDown && tileType==2 && (currentTile==4 || currentTile==5 || currentTile==6 || currentTile==7 || currentTile==8 || currentTile==9 ) && !erasePipeBool )
    {
        map.putTile(currentTile, layer1.getTileX(marker.x), layer1.getTileY(marker.y), layer1);
    }
    else if(game.input.mousePointer.isDown &&  (tileType==4 || tileType==5 || tileType==6 || tileType==7 || tileType==8 || tileType==9 ) && erasePipeBool )
    {
        map.putTile(currentTile, layer1.getTileX(marker.x), layer1.getTileY(marker.y), layer1);
    }
        else if(game.input.mousePointer.isDown &&  tileType==3 && eraseDigBool )
    {
        map.putTile(currentTile, layer1.getTileX(marker.x), layer1.getTileY(marker.y), layer1);
    }

}

function pickTile(sprite, pointer) {

    currentTile = game.math.snapToFloor(pointer.x, 50) / 50;

    if(currentTile==2)
    {
        currentTile=4;
    }
    else if(currentTile==4)
        currentTile=5;
    else if(currentTile==6)
        currentTile=6;
    else if(currentTile==8)
        currentTile=7;
    else if(currentTile==10)
        currentTile=8;
    else if(currentTile==12)
        currentTile=9;
    else if(currentTile==7)
        currentTile=3;
    else
        currentTile=0;

}

function waterPath()
{
    if(!waterPathBool)
    {
        findPathGround(0,0)
        
        if(end1)
            findPathRock(startRock[0],startRock[1],0);
        

        for(i=0; i<16; i++)
        {
            for(j=0; j<12; j++)
            {
                if(mapCopy[i][j]==21 || mapCopy[i][j]==31 || mapCopy[i][j]==20)
                {
                    var markerX = layer1.getTileX(i*50) ;
                    var markerY = layer1.getTileY(j*50) ;

                    //console.log('\n X:'+markerX+' Y: '+markerY+' Tile: '+10);

                    map.putTile(10, markerX, markerY , layer1);
                }
            }
        }

        waterPathBool=true;
    }
    else
    {
        waterPathBool=false;
    }
    
}

function update() 
{
    if(erasePipeBool)
        button1.frame=1;
    else
        button1.frame=0;

    if(eraseDigBool)
        button2.frame=1;
    else
        button2.frame=0;

    if(waterPathBool)
        button3.frame=1;
    else
        button3.frame=0;
}

function erasePipe()
{
    if(!erasePipeBool)
    {
        erasePipeBool=true;
        currentTile=2;
    }
    else
    {
        erasePipeBool=false;
        currentTile=0;
    }

}
function eraseDig()
{
    if(!eraseDigBool)
    {
        eraseDigBool=true;
        currentTile=12;
    }
    else
    {
        eraseDigBool=false;
        currentTile=3;
    }

}

function createTileSelector() {

    //  Our tile selection window
    var tileSelector = game.add.group();

    /*var tileSelectorBackground = game.make.graphics();
    tileSelectorBackground.beginFill(0x000000, 0.5);
    tileSelectorBackground.drawRect(0, 0, 800, 34);
    tileSelectorBackground.endFill();*/

    //tileSelector.add(tileSelectorBackground);

    var tileStrip = tileSelector.create(100, 650, 'tileselector');
    tileStrip.inputEnabled = true;
    tileStrip.events.onInputDown.add(pickTile, this);

    //tileSelector.fixedToCamera = true;


    //  Our painting marker
    marker = game.add.graphics();
    marker.lineStyle(2, 0x000000, 1);
    marker.drawRect(0, 0, 50, 50);

}

function render() {

    game.debug.text('current tile X:'+layer1.getTileX(game.input.activePointer.worldX), 32, 32, 'rgb(0,0,0)');
    game.debug.text('current tile Y:'+layer1.getTileY(game.input.activePointer.worldY), 32, 48, 'rgb(0,0,0)');

    game.debug.text('current tile:'+mapCopy[layer1.getTileX(game.input.activePointer.worldX)][layer1.getTileY(game.input.activePointer.worldY)], 32, 64, 'rgb(0,0,0)');

    //game.debug.text('erase dig bool:'+eraseDigBool, 32, 70, 'rgb(0,0,0)'); 
    game.debug.geom(line1);
    game.debug.geom(line2);
    game.debug.geom(line3);
    game.debug.geom(line4);
    game.debug.geom(line5);

}

function createArray(length) {
    var arr = new Array(length || 0),
        i = length;

    if (arguments.length > 1) {
        var args = Array.prototype.slice.call(arguments, 1);
        while(i--) arr[length-1 - i] = createArray.apply(this, args);
    }

    return arr;
}


function findPathGround(x,y)
{
    var auxTile;

    var markerX = layer1.getTileX(x*50) ;
    var markerY = layer1.getTileY(y*50) ;

    //console.log('\n X:'+markerX+' Y: '+markerY+' MapCopy: '+mapCopy[x][y]);

    auxTile=map.getTile(markerX,markerY);

    if(x<0 || y<0 || x>=16 || y>=13)
        return false;
    if(x==endCoords[0] && y==endCoords[1])
    {
        console.log("asdasd");
        end1=true;
        return true;
    }
    if(mapCopy[x][y]==1 || mapCopy[x][y]==2 || auxTile.index==0 || mapCopy[x][y]==20 || mapCopy[x][y]==21)
        return false;

    mapCopy[x][y]=20;

    console.log('\n X:'+x+' Y: '+y+' Tile: '+mapCopy[x][y]);

    //go north
    if(findPathGround(x,y-1)) return true;
    //go east
    if(findPathGround(x+1,y)) return true;
    //go south
    if(findPathGround(x,y+1)) return true;
    //go west
    if(findPathGround(x-1,y)) return true;
        
    mapCopy[x][y]=21;

    return false;
}

function findPathRock(x,y,lastRockTile,direction)
{
    var auxTile;

    var markerX = layer1.getTileX(x*50) ;
    var markerY = layer1.getTileY(y*50) ;

    //Me paro en esta tile
    auxTile=map.getTile(markerX,markerY);

    //console.log('\nRock X: '+x+' Y: '+y+' Tile: '+auxTile.index);

    //veo si está fuera del mapa
    if(x<0 || y<0 || x>=16 || y>=13)
        return false;
    console.log('\nRock.1 X: '+x+' Y: '+y+' Tile: '+auxTile.index);
    //si está dentro del mapa, veo que esté en roca, y que no se haya recorrido anteriormente
    if(mapCopy[x][y]==1 || mapCopy[x][y]==0 || auxTile.index==2 || mapCopy[x][y]==30 || mapCopy[x][y]==31)
        return false;
    console.log('\nRock.2 X: '+x+' Y: '+y+' Tile: '+auxTile.index);
    //veo si llegamos al final
    if(x==endCoords1[0] && y==endCoords1[1])
    {
        end1=false;
        return true;
    }
    console.log('\nRock 1 X: '+markerX+' Y: '+markerY+' Tile: '+auxTile.index);
    //inicio (es distinto a otros pasos). Quiero ver si es que estoy en una tile válida (5:vert, 8:codo N-E, 9:codo N-w)
    if(rockFirstStep)
    {
        lastRockTile=auxTile.index;
        rockFirstStep=false;
      
        if(!(auxTile.index==5 || auxTile.index==8 || auxTile.index==9))
            return false;
        else
        {
            if(auxTile.index==5)
            {
                //if(findPathRock(x,y-1,lastRockTile))
                    //return true;
                if(findPathRock(x,y+1,lastRockTile,'s'))
                    return true;
            }
            else if(auxTile.index==8)
            {
                //if(findPathRock(x,y-1))
                    //return true;
                if(findPathRock(x+1,y,lastRockTile,'e'))
                    return true;
            }
            else if(auxTile.index==9)
            {
                if(findPathRock(x-1,y,lastRockTile, 'w'))
                    return true;
                //if(findPathRock(x,y-1,lastRockTile))
                    //return true;
            }
        }
    }
    else
    {
        //verifiquemos que esta tile es válida
        //vertical from north
        if((lastRockTile==5 && direction=='n') && !(auxTile.index==5 || auxTile.index==6 || auxTile.index==7))
            return false;
        //vertical from south
        if((lastRockTile==5 && direction=='s') && !(auxTile.index==5 || auxTile.index==8 || auxTile.index==9))
            return false;
        //horizontal from west
        if((lastRockTile==4 && direction=='w') && !(auxTile.index==4 || auxTile.index==7 || auxTile.index==8))
            return false;
        //horizontal from east
        if((lastRockTile==4 && direction=='e') && !(auxTile.index==4 || auxTile.index==6 || auxTile.index==9))
            return false;
        //codo N-E from east
        if((lastRockTile==8 && direction=='e') && !(auxTile.index==4 || auxTile.index==6 || auxTile.index==9))
            return false;
        //codo N-E from north
        if((lastRockTile==8 && direction=='n') && !(auxTile.index==5 || auxTile.index==6 || auxTile.index==7))
            return false;
        //codo N-W from north
        if((lastRockTile==9 && direction=='n') && !(auxTile.index==5 || auxTile.index==6 || auxTile.index==7))
            return false;
        //codo N-W from west
        if((lastRockTile==9 && direction=='w') && !(auxTile.index==4 || auxTile.index==7 || auxTile.index==8))
            return false;
        //codo E-S from east
        if((lastRockTile==6 && direction=='e') && !(auxTile.index==4 || auxTile.index==7 || auxTile.index==8))
            return false;
        //codo E-S from east
        if((lastRockTile==6 && direction=='s') && !(auxTile.index==5 || auxTile.index==8 || auxTile.index==9))
            return false;
        //Codo W-S from west
        if((lastRockTile==7 && direction=='w') && !(auxTile.index==4 || auxTile.index==6 || auxTile.index==9))
            return false;
        //Codo W-S from south
        if((lastRockTile==7 && direction=='s') && !(auxTile.index==5 || auxTile.index==8 || auxTile.index==9))
            return false;
    }
    //console.log('\nRock2 X:'+markerX+' Y: '+markerY);

    
    //marco la tile como parte de la solución (distinta a la marca de ground)
    mapCopy[x][y]=30;

    console.log('\nRock 2 X: '+x+' Y: '+y+' Tile: '+auxTile.index);
    lastRockTile=auxTile.index;
    //If I am in horizontal, go east or west
    if(auxTile.index==4)
    {
        if(findPathRock(x-1,y,lastRockTile,'w'))
            return true;
        if(findPathRock(x+1,y,lastRockTile,'e'))
            return true;
    }
    //If I am in vertical, go south or north
    else if(auxTile.index==5)
    {
        if(findPathRock(x,y-1,lastRockTile,'n'))
            return true;
        if(findPathRock(x,y+1,lastRockTile,'s'))
            return true;
    }
    //If I am in codo west-south, go west or south
    else if(auxTile.index==6)
    {
        if(findPathRock(x-1,y,lastRockTile, 'w'))
            return true;
        if(findPathRock(x,y+1,lastRockTile, 's'))
            return true;
    }
    //If I am in codo east-south, go east or south
    else if(auxTile.index==7)
    {
        if(findPathRock(x,y+1,lastRockTile, 's'))
            return true;
        if(findPathRock(x+1,y,lastRockTile, 'e'))
            return true;
    }
    //If I am in codo north-east, go north or east
    else if(auxTile.index==8)
    {
        if(findPathRock(x,y-1,lastRockTile, 'n'))
            return true;
        if(findPathRock(x+1,y,lastRockTile, 'e'))
            return true;
    }
    //If I am in codo north-west, go north or west
    else if(auxTile.index==9)
    {
        if(findPathRock(x-1,y,lastRockTile, 'w'))
            return true;
        if(findPathRock(x,y-1,lastRockTile, 'n'))
            return true;
    }
        
    mapCopy[x][y]=31;

    return false;
}

function printMatrix()
{
    for(i=0; i<16; i++)
    {
        var str="";
        for(j=0; j<12; j++)
        {
            str=str.concat(mapCopy[i][j]+" ");
        }
        console.log(str);
    }
    console.log(" ");
}
</script>

</body>
</html>